@echo off
setlocal enabledelayedexpansion
title Python Diagnose - Wartungsmanager Kassen-System
color 0E
mode con: cols=90 lines=35

echo ========================================
echo üêç PYTHON DIAGNOSE - KASSEN-SYSTEM
echo ========================================
echo Version: 1.0 - Wartungsmanager Support
echo Datum: %date% %time%
echo ========================================
echo.

echo üìä ANALYSIERE PYTHON-INSTALLATION...
echo ======================================

echo.
echo üîç 1. STANDARD PYTHON-BEFEHLE TESTEN
echo ------------------------------------
set "PYTHON_FOUND=0"
set "PYTHON_PATH="
set "PYTHON_VERSION="

echo Teste 'python' Befehl...
python --version >nul 2>&1
if !errorlevel! equ 0 (
    echo ‚úÖ 'python' Befehl funktioniert
    for /f "tokens=*" %%i in ('python --version 2^>^&1') do set "PYTHON_VERSION=%%i"
    echo    Version: !PYTHON_VERSION!
    for /f "tokens=*" %%i in ('where python 2^>nul') do set "PYTHON_PATH=%%i"
    echo    Pfad: !PYTHON_PATH!
    set "PYTHON_FOUND=1"
    set "WORKING_PYTHON=python"
) else (
    echo ‚ùå 'python' Befehl nicht erkannt
)

echo.
echo Teste 'py' Launcher...
py --version >nul 2>&1
if !errorlevel! equ 0 (
    echo ‚úÖ 'py' Launcher funktioniert
    py --version
    echo    Verf√ºgbare Versionen:
    py -0 2>nul
    if !PYTHON_FOUND! equ 0 (
        set "PYTHON_FOUND=1"
        set "WORKING_PYTHON=py"
    )
) else (
    echo ‚ùå 'py' Launcher nicht erkannt
)

echo.
echo üîç 2. MANUELLE INSTALLATION SUCHEN
echo ----------------------------------
echo Suche Python in Standard-Pfaden...

REM Standard-Installationspfade durchsuchen
set "SEARCH_PATHS=C:\Python311;C:\Python311\;C:\Python312;C:\Program Files\Python311;C:\Program Files (x86)\Python311;%USERPROFILE%\AppData\Local\Programs\Python\Python311;%USERPROFILE%\AppData\Local\Programs\Python\Python312"

for %%p in (!SEARCH_PATHS!) do (
    if exist "%%p\python.exe" (
        echo ‚úÖ Python gefunden: %%p\python.exe
        "%%p\python.exe" --version 2>nul
        if !PYTHON_FOUND! equ 0 (
            set "PYTHON_FOUND=1"
            set "WORKING_PYTHON=%%p\python.exe"
            set "MANUAL_PYTHON_PATH=%%p"
        )
    )
)

if !PYTHON_FOUND! equ 0 (
    echo ‚ùå Keine Python-Installation gefunden
)

echo.
echo üîç 3. WARTUNGSMANAGER VIRTUAL ENVIRONMENT
echo ------------------------------------------
cd /d "C:\SoftwareProjekte\WartungsManager\Source\Python" 2>nul
if !errorlevel! equ 0 (
    echo Pr√ºfe Virtual Environment...
    if exist "wartung_env\Scripts\python.exe" (
        echo ‚úÖ Virtual Environment gefunden
        echo    Pfad: %CD%\wartung_env
        wartung_env\Scripts\python.exe --version 2>nul
        echo    Teste pip...
        wartung_env\Scripts\pip.exe --version >nul 2>&1
        if !errorlevel! equ 0 (
            echo ‚úÖ pip im Virtual Environment funktioniert
        ) else (
            echo ‚ùå pip im Virtual Environment defekt
        )
    ) else (
        echo ‚ùå Virtual Environment fehlt oder besch√§digt
    )
) else (
    echo ‚ùå Wartungsmanager-Projektverzeichnis nicht gefunden
)

echo.
echo üîç 4. SYSTEM-PFAD ANALYSE
echo -------------------------
echo Aktuelle PATH-Variable analysieren...
echo %PATH% | findstr /i python >nul
if !errorlevel! equ 0 (
    echo ‚úÖ Python-Pfade in PATH gefunden:
    echo %PATH% | findstr /i python
) else (
    echo ‚ùå Keine Python-Pfade in PATH-Variable
)

echo.
echo üîç 5. REGISTRY-ANALYSE
echo ----------------------
echo Pr√ºfe Python-Registrierung...
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Python" >nul 2>&1
if !errorlevel! equ 0 (
    echo ‚úÖ Python in System-Registry gefunden
    reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Python\PythonCore" 2>nul | findstr /i "3.11\|3.12"
) else (
    echo ‚ùå Python nicht in System-Registry
)

reg query "HKEY_CURRENT_USER\SOFTWARE\Python" >nul 2>&1
if !errorlevel! equ 0 (
    echo ‚úÖ Python in Benutzer-Registry gefunden
) else (
    echo ‚ùå Python nicht in Benutzer-Registry
)

echo.
echo üîç 6. WARTUNGSMANAGER ANFORDERUNGEN PR√úFEN
echo -------------------------------------------
if exist "C:\SoftwareProjekte\WartungsManager\Source\Python\requirements.txt" (
    echo ‚úÖ Requirements-Datei gefunden
    echo Analysiere Abh√§ngigkeiten...
    type "C:\SoftwareProjekte\WartungsManager\Source\Python\requirements.txt" | findstr /v "^#" | findstr /v "^$" | wc -l 2>nul
    echo    Flask-Framework und SQLAlchemy erforderlich
) else (
    echo ‚ùå Requirements-Datei nicht gefunden
)

echo.
echo ========================================
echo üìã DIAGNOSE-ZUSAMMENFASSUNG
echo ========================================

if !PYTHON_FOUND! equ 1 (
    echo ‚úÖ PYTHON GEFUNDEN
    echo    Funktionsf√§higer Python-Befehl: !WORKING_PYTHON!
    if defined PYTHON_VERSION echo    Version: !PYTHON_VERSION!
    if defined MANUAL_PYTHON_PATH echo    Installationspfad: !MANUAL_PYTHON_PATH!
    
    echo.
    echo üîß EMPFOHLENE REPARATUR-AKTIONEN:
    echo ================================
    
    if "!WORKING_PYTHON!"=="python" (
        echo ‚úÖ Python-Befehl funktioniert bereits korrekt
        echo    Kein PATH-Problem vorhanden
    ) else (
        echo ‚ö†Ô∏è  Python-PATH muss repariert werden
        echo    Python ist installiert, aber nicht im PATH
    )
    
    echo.
    echo üí° N√ÑCHSTE SCHRITTE:
    echo ===================
    echo 1. Virtual Environment neu erstellen
    echo 2. Dependencies installieren  
    echo 3. Wartungsmanager starten
    echo.
    echo M√∂chten Sie die automatische Reparatur starten? (j/n)
    set /p repair_choice="Ihre Wahl: "
    
    if /i "!repair_choice!"=="j" (
        echo.
        echo üîß STARTE AUTOMATISCHE REPARATUR...
        echo ===================================
        call :repair_python
    )
    
) else (
    echo ‚ùå PYTHON NICHT GEFUNDEN
    echo.
    echo üö® KRITISCHES PROBLEM:
    echo ======================
    echo Python ist nicht installiert oder nicht funktionsf√§hig
    echo.
    echo üí° L√ñSUNGSOPTIONEN:
    echo ==================
    echo 1. Python 3.11.8 von python.org installieren
    echo 2. Wartungsmanager-Installer verwenden (setup_wartungsmanager.bat)
    echo 3. Python Portable manuell installieren
    echo.
    echo M√∂chten Sie Python automatisch installieren? (j/n)
    set /p install_choice="Ihre Wahl: "
    
    if /i "!install_choice!"=="j" (
        echo.
        echo üì• INSTALLIERE PYTHON AUTOMATISCH...
        echo ===================================
        call :install_python
    )
)

echo.
echo ========================================
echo üìù DIAGNOSE-LOG ERSTELLEN
echo ========================================
echo Erstelle detailliertes Log...

set "LOG_FILE=C:\SoftwareProjekte\WartungsManager\Logs\python_diagnose_%date:~10,4%-%date:~4,2%-%date:~7,2%_%time:~0,2%-%time:~3,2%.log"
if not exist "C:\SoftwareProjekte\WartungsManager\Logs" mkdir "C:\SoftwareProjekte\WartungsManager\Logs" >nul 2>&1

(
echo Python Diagnose Log - %date% %time%
echo =====================================
echo.
echo Python gefunden: !PYTHON_FOUND!
echo Funktionsf√§higer Befehl: !WORKING_PYTHON!
echo Version: !PYTHON_VERSION!
echo Pfad: !PYTHON_PATH!
echo Manueller Pfad: !MANUAL_PYTHON_PATH!
echo.
echo System-PATH:
echo %PATH%
echo.
echo Registry-Status:
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Python" 2^>nul ^|^| echo NICHT_GEFUNDEN
echo.
echo Virtual Environment Status:
if exist "C:\SoftwareProjekte\WartungsManager\Source\Python\wartung_env\Scripts\python.exe" ^(
    echo GEFUNDEN
^) else ^(
    echo FEHLT
^)
) > "%LOG_FILE%" 2>&1

echo ‚úÖ Log erstellt: %LOG_FILE%

echo.
echo Diagnose abgeschlossen!
echo Dr√ºcken Sie eine Taste zum Beenden...
pause >nul
exit /b 0

:repair_python
echo.
echo üîß PYTHON-REPARATUR GESTARTET
echo =============================

REM Zum Projektverzeichnis wechseln
cd /d "C:\SoftwareProjekte\WartungsManager\Source\Python" 2>nul
if !errorlevel! neq 0 (
    echo ‚ùå Projektverzeichnis nicht erreichbar
    goto repair_end
)

echo 1. Alte Virtual Environment l√∂schen...
if exist "wartung_env" (
    echo    L√∂sche wartung_env...
    rmdir /s /q "wartung_env" >nul 2>&1
    echo ‚úÖ Alte Virtual Environment entfernt
)

echo.
echo 2. Neue Virtual Environment erstellen...
"!WORKING_PYTHON!" -m venv wartung_env
if !errorlevel! equ 0 (
    echo ‚úÖ Virtual Environment erfolgreich erstellt
) else (
    echo ‚ùå Virtual Environment-Erstellung fehlgeschlagen
    goto repair_end
)

echo.
echo 3. Virtual Environment aktivieren und Dependencies installieren...
call wartung_env\Scripts\activate.bat

if exist "requirements.txt" (
    echo    Installiere Requirements...
    wartung_env\Scripts\pip.exe install -r requirements.txt --quiet
    if !errorlevel! equ 0 (
        echo ‚úÖ Dependencies erfolgreich installiert
    ) else (
        echo ‚ö†Ô∏è  Einige Dependencies konnten nicht installiert werden
    )
) else (
    echo ‚ùå requirements.txt nicht gefunden
)

echo.
echo 4. Test: Wartungsmanager starten...
echo Teste Flask-Import...
wartung_env\Scripts\python.exe -c "import flask; print('Flask Version:', flask.__version__)"
if !errorlevel! equ 0 (
    echo ‚úÖ Flask funktioniert korrekt
    echo.
    echo üöÄ REPARATUR ERFOLGREICH!
    echo =========================
    echo Sie k√∂nnen jetzt Wartungsmanager starten:
    echo 1. cd C:\SoftwareProjekte\WartungsManager\Source\Python
    echo 2. wartung_env\Scripts\activate.bat
    echo 3. python run.py
) else (
    echo ‚ùå Flask-Import fehlgeschlagen
)

:repair_end
echo.
echo Reparatur abgeschlossen.
return

:install_python
echo.
echo üì• PYTHON-INSTALLATION GESTARTET
echo ================================

REM Administratorrechte pr√ºfen
openfiles >nul 2>&1
if !errorlevel! neq 0 (
    echo ‚ö†Ô∏è  Administrator-Rechte erforderlich f√ºr Python-Installation
    echo Starte als Administrator...
    powershell -Command "Start-Process '%0' -Verb RunAs"
    exit /b
)

echo 1. Lade Python 3.11.8 herunter...
set "PYTHON_URL=https://www.python.org/ftp/python/3.11.8/python-3.11.8-amd64.exe"
set "PYTHON_INSTALLER=%TEMP%\python-3.11.8-installer.exe"

powershell -Command "Invoke-WebRequest -Uri '%PYTHON_URL%' -OutFile '%PYTHON_INSTALLER%'" 2>nul

if exist "%PYTHON_INSTALLER%" (
    echo ‚úÖ Download erfolgreich
    
    echo.
    echo 2. Installiere Python...
    echo    Stille Installation mit PATH-Integration...
    "%PYTHON_INSTALLER%" /quiet InstallAllUsers=1 PrependPath=1 Include_test=0
    
    echo.
    echo 3. Installation abgeschlossen, teste...
    timeout /t 5 /nobreak >nul
    
    REM PATH neu laden
    call :refresh_environment
    
    python --version >nul 2>&1
    if !errorlevel! equ 0 (
        echo ‚úÖ Python erfolgreich installiert!
        python --version
        set "PYTHON_FOUND=1"
        set "WORKING_PYTHON=python"
        
        echo.
        echo M√∂chten Sie jetzt die Virtual Environment einrichten? (j/n)
        set /p setup_venv="Ihre Wahl: "
        if /i "!setup_venv!"=="j" call :repair_python
    ) else (
        echo ‚ùå Python-Installation fehlgeschlagen
        echo Bitte Python manuell von python.org installieren
    )
    
    REM Installer l√∂schen
    del "%PYTHON_INSTALLER%" >nul 2>&1
) else (
    echo ‚ùå Download fehlgeschlagen
    echo Bitte Python manuell von python.org installieren
)

return

:refresh_environment
REM Aktualisiert die Umgebungsvariablen ohne Neustart
for /f "tokens=2*" %%a in ('reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment" /v PATH') do set "SYSTEM_PATH=%%b"
for /f "tokens=2*" %%a in ('reg query "HKEY_CURRENT_USER\Environment" /v PATH 2^>nul') do set "USER_PATH=%%b"
set "PATH=%SYSTEM_PATH%;%USER_PATH%"
return
