{% extends "admin_layout.html" %}

{% block title %}Shelly IoT Dashboard - WartungsManager{% endblock %}

{% block styles %}
<style>
    .shelly-widget {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .shelly-widget:hover {
        transform: translateY(-5px);
    }
    
    .shelly-kompressor {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        min-height: 200px;
    }
    
    .shelly-device {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .power-display {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .switch-btn {
        width: 80px;
        height: 40px;
        background: #ccc;
        border-radius: 40px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .switch-btn.active {
        background: #4CAF50;
    }
    
    .switch-btn .slider {
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .switch-btn.active .slider {
        transform: translateX(40px);
    }
    
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-online { background: #4CAF50; }
    .status-offline { background: #f44336; }
    
    .config-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;
    }
    
    .config-btn:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center">
                <i class="fas fa-plug me-3"></i>Shelly IoT Dashboard
            </h1>
        </div>
    </div>

    <!-- Kompressor-Widget (Hauptgerät) -->
    <div id="kompressor-widget" style="display: none;">
        <div class="shelly-widget shelly-kompressor">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-3">
                        <i class="fas fa-cog me-2"></i>
                        <span id="kompressor-name">K14 Kompressor</span>
                    </h2>
                    <div class="mb-3">
                        <span class="status-indicator status-online" id="kompressor-status-led"></span>
                        <span id="kompressor-status-text">Online</span> • 
                        <span id="kompressor-ip">192.168.0.163</span>
                    </div>
                    <div class="power-display">
                        <i class="fas fa-bolt me-2"></i>
                        <span id="kompressor-power">0</span> W
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="mb-3">
                        <small class="d-block mb-2">Temperatur</small>
                        <h3><span id="kompressor-temp">--</span>°C</h3>
                    </div>
                    <div class="switch-btn" id="kompressor-switch" onclick="toggleKompressor()">
                        <div class="slider"></div>
                    </div>
                    <small class="d-block mt-2 text-muted">Click zum Ein-/Ausschalten</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Weitere Shelly-Geräte -->
    <div class="device-grid" id="device-grid">
        <!-- Geräte werden dynamisch eingefügt -->
    </div>

    <!-- Keine Geräte Nachricht -->
    <div id="no-devices" class="text-center py-5" style="display: none;">
        <i class="fas fa-plug fa-5x text-muted mb-3"></i>
        <h3>Keine Shelly-Geräte konfiguriert</h3>
        <p class="text-muted">Klicken Sie auf den Konfigurations-Button, um Geräte hinzuzufügen</p>
    </div>

    <!-- Live-Status -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Live-Aktualisierung:</strong> Status wird alle 5 Sekunden aktualisiert
                <span class="float-end">
                    <small id="last-update">Letztes Update: --</small>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Konfigurations-Button -->
<button class="config-btn" onclick="window.location.href='/shelly/config'">
    <i class="fas fa-cog fa-2x"></i>
</button>

<!-- Konfigurations-Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Shelly-Gerät konfigurieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deviceConfigForm">
                    <div class="mb-3">
                        <label class="form-label">Geräte-IP</label>
                        <input type="text" class="form-control" id="device-ip" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Anzeigename</label>
                        <input type="text" class="form-control" id="device-name" 
                               placeholder="z.B. Werkstatt-Licht">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rolle</label>
                        <select class="form-control" id="device-role">
                            <option value="widget">Standard-Widget</option>
                            <option value="kompressor">Kompressor-Steuerung</option>
                            <option value="hidden">Versteckt</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveDeviceConfig()">Speichern</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Gespeicherte Geräte-Konfiguration
let deviceConfig = JSON.parse(localStorage.getItem('shelly_devices') || '[]');

// Aktuelle Geräte-Stati
let deviceStatus = {};

// Update-Interval
let updateInterval = null;

// Beim Laden initialisieren
document.addEventListener('DOMContentLoaded', function() {
    loadDeviceConfig();
    updateDeviceStatus();
    
    // Auto-Update alle 5 Sekunden
    updateInterval = setInterval(updateDeviceStatus, 5000);
});

// Geräte-Konfiguration laden
function loadDeviceConfig() {
    // Aus localStorage laden oder von API abrufen
    fetch('/shelly/api/config')
        .then(response => response.json())
        .then(data => {
            if (data.devices && data.devices.length > 0) {
                deviceConfig = data.devices;
                localStorage.setItem('shelly_devices', JSON.stringify(deviceConfig));
                renderDevices();
            } else {
                // Zeige "Keine Geräte" Nachricht
                document.getElementById('no-devices').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Konfiguration:', error);
            // Fallback auf localStorage
            if (deviceConfig.length > 0) {
                renderDevices();
            } else {
                document.getElementById('no-devices').style.display = 'block';
            }
        });
}

// Geräte rendern
function renderDevices() {
    const kompressorWidget = document.getElementById('kompressor-widget');
    const deviceGrid = document.getElementById('device-grid');
    
    // Clear grid
    deviceGrid.innerHTML = '';
    
    // Hide no-devices message
    document.getElementById('no-devices').style.display = 'none';
    
    deviceConfig.forEach(device => {
        if (device.role === 'kompressor') {
            // Kompressor-Widget anzeigen
            kompressorWidget.style.display = 'block';
            document.getElementById('kompressor-name').textContent = device.custom_name || 'Kompressor';
            document.getElementById('kompressor-ip').textContent = device.ip;
            kompressorWidget.dataset.deviceIp = device.ip;
        } else if (device.role === 'widget') {
            // Standard-Widget erstellen
            const widget = createDeviceWidget(device);
            deviceGrid.appendChild(widget);
        }
        // "hidden" Geräte werden nicht angezeigt
    });
}

// Device Widget erstellen
function createDeviceWidget(device) {
    const div = document.createElement('div');
    div.className = 'shelly-widget shelly-device';
    div.dataset.deviceIp = device.ip;
    
    div.innerHTML = `
        <h4 class="mb-3">
            <i class="fas fa-lightbulb me-2"></i>
            ${device.custom_name || device.name || 'Shelly Gerät'}
        </h4>
        <div class="mb-3">
            <span class="status-indicator status-offline" data-status="${device.ip}"></span>
            <span data-status-text="${device.ip}">Offline</span> • 
            <small>${device.ip}</small>
        </div>
        <div class="row align-items-center">
            <div class="col-6">
                <div class="power-display">
                    <span data-power="${device.ip}">--</span> W
                </div>
            </div>
            <div class="col-6 text-end">
                <div class="switch-btn" data-switch="${device.ip}" onclick="toggleDevice('${device.ip}')">
                    <div class="slider"></div>
                </div>
            </div>
        </div>
        <div class="mt-3 text-muted">
            <small>${device.model || 'Unbekanntes Modell'}</small>
        </div>
    `;
    
    return div;
}

// Geräte-Status aktualisieren
function updateDeviceStatus() {
    deviceConfig.forEach(device => {
        fetch(`/shelly/api/device/${device.ip}/status`)
            .then(response => response.json())
            .then(data => {
                updateDeviceDisplay(device.ip, data);
            })
            .catch(error => {
                console.error(`Fehler bei ${device.ip}:`, error);
                updateDeviceDisplay(device.ip, { online: false });
            });
    });
    
    // Update timestamp
    const now = new Date();
    document.getElementById('last-update').textContent = 
        `Letztes Update: ${now.toLocaleTimeString('de-DE')}`;
}

// Anzeige aktualisieren
function updateDeviceDisplay(ip, status) {
    // Status-LED
    const statusLed = document.querySelector(`[data-status="${ip}"]`);
    if (statusLed) {
        statusLed.className = status.online ? 
            'status-indicator status-online' : 
            'status-indicator status-offline';
    }
    
    // Status-Text
    const statusText = document.querySelector(`[data-status-text="${ip}"]`);
    if (statusText) {
        statusText.textContent = status.online ? 'Online' : 'Offline';
    }
    
    // Power
    const powerDisplay = document.querySelector(`[data-power="${ip}"]`);
    if (powerDisplay && status.power !== undefined) {
        powerDisplay.textContent = status.power.toFixed(1);
    }
    
    // Switch-Status
    const switchBtn = document.querySelector(`[data-switch="${ip}"]`);
    if (switchBtn && status.is_on !== undefined) {
        switchBtn.classList.toggle('active', status.is_on);
    }
    
    // Kompressor-spezifische Updates
    if (ip === document.getElementById('kompressor-widget')?.dataset.deviceIp) {
        if (status.temperature !== undefined) {
            document.getElementById('kompressor-temp').textContent = status.temperature.toFixed(1);
        }
        if (status.power !== undefined) {
            document.getElementById('kompressor-power').textContent = status.power.toFixed(1);
        }
    }
}

// Kompressor umschalten
function toggleKompressor() {
    const widget = document.getElementById('kompressor-widget');
    const ip = widget.dataset.deviceIp;
    const switchBtn = document.getElementById('kompressor-switch');
    const isOn = switchBtn.classList.contains('active');
    
    // Bestätigung für Kompressor
    if (!isOn) {
        // Einschalten - Öl-Test Dialog vom Dashboard verwenden
        if (confirm('Kompressor einschalten?\n\nHinweis: Öl-Test muss durchgeführt sein!')) {
            toggleDeviceApi(ip, true, 'kompressor');
        }
    } else {
        // Ausschalten
        if (confirm('Kompressor wirklich ausschalten?')) {
            toggleDeviceApi(ip, false, 'kompressor');
        }
    }
}

// Normales Gerät umschalten
function toggleDevice(ip) {
    const switchBtn = document.querySelector(`[data-switch="${ip}"]`);
    const isOn = switchBtn.classList.contains('active');
    
    toggleDeviceApi(ip, !isOn, 'device');
}

// API-Aufruf zum Umschalten
function toggleDeviceApi(ip, turnOn, type = 'device') {
    const endpoint = turnOn ? 'on' : 'off';
    
    fetch(`/shelly/api/device/${ip}/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            type: type,
            source: 'dashboard'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Status sofort aktualisieren
            updateDeviceStatus();
            
            // Erfolgsmeldung
            showToast(`${type === 'kompressor' ? 'Kompressor' : 'Gerät'} ${turnOn ? 'eingeschaltet' : 'ausgeschaltet'}`, 'success');
        } else {
            showToast('Fehler: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Verbindungsfehler: ' + error.message, 'danger');
    });
}

// Toast-Benachrichtigungen
function showToast(message, type = 'info') {
    // Nutze die Toast-Funktion vom Dashboard
    if (window.parent && window.parent.showToast) {
        window.parent.showToast(message, type);
    } else {
        // Fallback auf Alert
        alert(message);
    }
}

// Konfigurations-Dialog öffnen
function openConfig(ip) {
    const device = deviceConfig.find(d => d.ip === ip);
    if (device) {
        document.getElementById('device-ip').value = device.ip;
        document.getElementById('device-name').value = device.custom_name || '';
        document.getElementById('device-role').value = device.role || 'widget';
        
        const modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
    }
}

// Konfiguration speichern
function saveDeviceConfig() {
    const ip = document.getElementById('device-ip').value;
    const name = document.getElementById('device-name').value;
    const role = document.getElementById('device-role').value;
    
    // Update in config
    const device = deviceConfig.find(d => d.ip === ip);
    if (device) {
        device.custom_name = name;
        device.role = role;
        
        // Speichern
        localStorage.setItem('shelly_devices', JSON.stringify(deviceConfig));
        
        // An API senden
        fetch('/shelly/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ devices: deviceConfig })
        });
        
        // Neu rendern
        renderDevices();
        
        // Modal schließen
        bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
    }
}

// Cleanup beim Verlassen
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}
